---
import Base from "@layouts/Base.astro";
import Page from "@layouts/Page.astro";
---

<Base meta_title="Calculadora MBI">
  <Page title="Calculadora MBI">
    <div class="max-w-3xl mx-auto p-6">
      <!-- Selector de pestañas -->
      <div class="flex space-x-4 mb-6">
        <button id="tab-calculo1" class="px-4 py-2 font-semibold rounded bg-blue-500 text-white">Cálculo 1</button>
        <button id="tab-algebra1" class="px-4 py-2 font-semibold rounded bg-gray-200 text-gray-700">Álgebra 1</button>
        <button id="tab-fisica1" class="px-4 py-2 font-semibold rounded bg-gray-200 text-gray-700">Física 1</button>
      </div>

      <!-- SECCIÓN CÁLCULO 1 -->
      <section id="seccion-calculo1">
        <h2 class="text-xl font-bold mb-4">Cálculo 1</h2>
        <form class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block mb-1 font-semibold text-white">PEP 1 (30%)</label>
              <input id="pep1-calculo1" type="number" min="1" max="7" step="0.01" placeholder="Ej: 5.0"
                class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block mb-1 font-semibold text-white">PEP 2 (30%)</label>
              <input id="pep2-calculo1" type="number" min="1" max="7" step="0.01" placeholder="Ej: 6.0"
                class="w-full border rounded px-2 py-1" />
            </div>
          </div>

          <div>
            <p class="font-semibold mb-2">Talleres (15% - Promedio de los mejores 2)</p>
            <div class="grid grid-cols-3 gap-4">
              <input id="taller1-calculo1" type="number" min="1" max="7" step="0.01" placeholder="Taller 1"
                class="border rounded px-2 py-1" />
              <input id="taller2-calculo1" type="number" min="1" max="7" step="0.01" placeholder="Taller 2"
                class="border rounded px-2 py-1" />
              <input id="taller3-calculo1" type="number" min="1" max="7" step="0.01" placeholder="Taller 3"
                class="border rounded px-2 py-1" />
            </div>
          </div>

          <div>
            <p class="font-semibold mb-2">Controles (25% - Promedio de los mejores 2)</p>
            <div class="grid grid-cols-3 gap-4">
              <input id="control1-calculo1" type="number" min="1" max="7" step="0.01" placeholder="Control 1"
                class="border rounded px-2 py-1" />
              <input id="control2-calculo1" type="number" min="1" max="7" step="0.01" placeholder="Control 2"
                class="border rounded px-2 py-1" />
              <input id="control3-calculo1" type="number" min="1" max="7" step="0.01" placeholder="Control 3"
                class="border rounded px-2 py-1" />
            </div>
          </div>

          <div>
            <label class="block mb-1 font-semibold text-white">Meta para aprobar</label>
            <input id="notaMeta-calculo1" type="number" min="1" max="7" step="0.01" value="3.95"
              class="w-full border rounded px-2 py-1" />
          </div>

          <button id="btn-calcular-calculo1" type="button"
            class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
            Calcular
          </button>
        </form>
        <p id="resultado-calculo1" class="mt-4 font-semibold"></p>
      </section>

      <!-- SECCIÓN ÁLGEBRA 1 -->
      <section id="seccion-algebra1" class="hidden">
        <h2 class="text-xl font-bold mb-4">Álgebra 1</h2>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block mb-1 font-semibold text-white">PEP 1 (30%)</label>
            <input id="pep1-algebra1" type="number" min="1" max="7" step="0.01" placeholder="Ej: 5.0"
              class="w-full border rounded px-2 py-1" />
          </div>
          <div>
            <label class="block mb-1 font-semibold text-white">PEP 2 (30%)</label>
            <input id="pep2-algebra1" type="number" min="1" max="7" step="0.01" placeholder="Ej: 6.0"
              class="w-full border rounded px-2 py-1" />
          </div>
        </div>
        <div>
          <p class="font-semibold mb-2">Talleres (15% - Promedio de los mejores 2)</p>
          <div class="grid grid-cols-3 gap-4">
            <input id="taller1-algebra1" type="number" min="1" max="7" step="0.01" placeholder="Taller 1"
              class="border rounded px-2 py-1" />
            <input id="taller2-algebra1" type="number" min="1" max="7" step="0.01" placeholder="Taller 2"
              class="border rounded px-2 py-1" />
            <input id="taller3-algebra1" type="number" min="1" max="7" step="0.01"  placeholder="Taller 3"
              class="border rounded px-2 py-1" />
          </div>
        </div>
        <div>
          <p class="font-semibold mb-2">Controles (25% - Promedio de los mejores 2)</p>
          <div class="grid grid-cols-3 gap-4">
            <input id="control1-algebra1" type="number" min="1" max="7" step="0.01" placeholder="Control 1"
              class="border rounded px-2 py-1" />
            <input id="control2-algebra1" type="number" min="1" max="7" step="0.01" placeholder="Control 2"
              class="border rounded px-2 py-1" />
            <input id="control3-algebra1" type="number" min="1" max="7" step="0.01" placeholder="Control 3"
              class="border rounded px-2 py-1" />
          </div>
        </div>
        <div>
          <label class="block mb-1 font-semibold text-white">Meta para aprobar</label>
          <input id="notaMeta-algebra1" type="number" min="1" max="7" step="0.01" value="3.95"
            class="w-full border rounded px-2 py-1" />
        </div>
        <button id="btn-calcular-algebra1" type="button"
          class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
          Calcular
        </button>
        <p id="resultado-algebra1" class="mt-4 font-semibold"></p>
      </section>

      <!-- SECCIÓN FÍSICA 1 -->
      <section id="seccion-fisica1" class="hidden">
        <h2 class="text-xl font-bold mb-4">Física 1</h2>
        <form class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block mb-1 font-semibold text-white">PEP 1 (40%)</label>
              <input id="pep1-fisica1" type="number" min="1" max="7" step="0.01" placeholder="Ej: 5.0"
                class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block mb-1 font-semibold text-white">PEP 2 (40%)</label>
              <input id="pep2-fisica1" type="number" min="1" max="7" step="0.01" placeholder="Ej: 6.0"
                class="w-full border rounded px-2 py-1" />
            </div>
          </div>
          <div>
            <label class="block mb-1 font-semibold text-white">Control (20%)</label>
            <input id="control-fisica1" type="number" min="1" max="7" step="0.01" placeholder="Ej: 5.5"
              class="w-full border rounded px-2 py-1" />
          </div>
          <div>
            <label class="block mb-1 font-semibold text-white">Meta para aprobar</label>
            <input id="notaMeta-fisica1" type="number" min="1" max="7" step="0.01" value="3.95" 
              class="w-full border rounded px-2 py-1" />
          </div>
          <button id="btn-calcular-fisica1" type="button"
            class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
            Calcular
          </button>
        </form>
        <p id="resultado-fisica1" class="mt-4 font-semibold"></p>
      </section>
    </div>

    <!-- SCRIPT DE LÓGICA -->
    <script type="module" client:load>
      const config = {
        calculo1: {
          pepIds: ['pep1-calculo1','pep2-calculo1'],
          tallerIds: ['taller1-calculo1','taller2-calculo1','taller3-calculo1'], wT: 0.15,
          controlIds:['control1-calculo1','control2-calculo1','control3-calculo1'], wC: 0.25
        },
        algebra1: {
          pepIds: ['pep1-algebra1','pep2-algebra1'],
          tallerIds: ['taller1-algebra1','taller2-algebra1','taller3-algebra1'], wT: 0.15,
          controlIds:['control1-algebra1','control2-algebra1','control3-algebra1'], wC: 0.25
        },
        fisica1: {
          examIds: ['pep1-fisica1','pep2-fisica1','control-fisica1'],
          weights: { 'pep1-fisica1':0.4,'pep2-fisica1':0.4,'control-fisica1':0.2 }
        }
      };

      // Manejo de pestañas
      const tabs = ['calculo1','algebra1','fisica1'];
      function switchTab(active) {
        tabs.forEach(n => {
          document.getElementById(`tab-${n}`).classList.toggle('bg-blue-500', n===active);
          document.getElementById(`tab-${n}`).classList.toggle('text-white', n===active);
          document.getElementById(`tab-${n}`).classList.toggle('bg-gray-200', n!==active);
          document.getElementById(`tab-${n}`).classList.toggle('text-gray-700', n!==active);
          document.getElementById(`seccion-${n}`).classList.toggle('hidden', n!==active);
        });
      }
      tabs.forEach(n => document.getElementById(`tab-${n}`).addEventListener('click', () => switchTab(n)));
      switchTab('calculo1');

      function calcNota(ramo) {
        let sumKnown = 0;
        const toFill = [];
        const target = parseFloat(document.getElementById(`notaMeta-${ramo}`).value) || 3.95;

        if (ramo === 'fisica1') {
          const { examIds, weights } = config.fisica1;
          for (let id of examIds) {
            const el = document.getElementById(id);
            const v = parseFloat(el.value);
            const w = weights[id];
            if (!isNaN(v)) {
              sumKnown += v * w;
              el.classList.remove('bg-orange-100');
            } else {
              toFill.push({ el, w });
            }
          }
        } else {
          const { pepIds, tallerIds, controlIds, wT, wC } = config[ramo];
          // PEPs
          pepIds.forEach(id => {
            const el = document.getElementById(id);
            const v = parseFloat(el.value);
            const w = 0.3;
            if (!isNaN(v)) {
              sumKnown += v * w;
              el.classList.remove('bg-orange-100');
            } else {
              toFill.push({ el, w });
            }
          });
          // Talleres
          {
            const known = tallerIds.map(id => parseFloat(document.getElementById(id).value)).filter(n => !isNaN(n));
            const blanks = tallerIds.filter(id => isNaN(parseFloat(document.getElementById(id).value)));
            const need = Math.max(0, 2 - known.length);
            const wPer = wT / 2;
            if (known.length >= 2) {
              const best2 = known.sort((a,b)=>b-a).slice(0,2);
              sumKnown += (best2[0]+best2[1])/2 * wT;
            } else if (known.length === 1) {
              sumKnown += known[0] * wPer;
            }
            blanks.slice(0, need).forEach(id => toFill.push({ el: document.getElementById(id), w: wPer }));
            blanks.slice(need).forEach(id => document.getElementById(id).classList.remove('bg-orange-100'));
          }
          // Controles
          {
            const known = controlIds.map(id => parseFloat(document.getElementById(id).value)).filter(n => !isNaN(n));
            const blanks = controlIds.filter(id => isNaN(parseFloat(document.getElementById(id).value)));
            const need = Math.max(0, 2 - known.length);
            const wPer = wC / 2;
            if (known.length >= 2) {
              const best2 = known.sort((a,b)=>b-a).slice(0,2);
              sumKnown += (best2[0]+best2[1])/2 * wC;
            } else if (known.length === 1) {
              sumKnown += known[0] * wPer;
            }
            blanks.slice(0, need).forEach(id => toFill.push({ el: document.getElementById(id), w: wPer }));
            blanks.slice(need).forEach(id => document.getElementById(id).classList.remove('bg-orange-100'));
          }
        }

        // Rellenar faltantes a un decimal
        const totalW = toFill.reduce((acc,o)=>acc+o.w,0);
        if (totalW>0) {
          const needed = (target - sumKnown) / totalW;
          toFill.forEach(({el})=>{
            el.value = needed.toFixed(1);
            el.classList.add('bg-orange-100');
          });
          sumKnown += needed * totalW;
        }

        // Mostrar resultado
        document.getElementById(`resultado-${ramo}`).textContent =
          `Si obtienes esas notas, tu promedio será ${sumKnown.toFixed(2)}.`;
      }

      // Suscribir botones de calcular
      document.getElementById('btn-calcular-calculo1').addEventListener('click', () => calcNota('calculo1'));
      document.getElementById('btn-calcular-algebra1').addEventListener('click', () => calcNota('algebra1'));
      document.getElementById('btn-calcular-fisica1').addEventListener('click', () => calcNota('fisica1'));
    </script>
  </Page>
</Base>
